<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <script src="plotly-latest.min.js"></script>
    <script src="PapaParse-4.1.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="myDiv1" style="width: 100%; height: 600px;"></div>
    <div class="buttons">
        Filter by GPU number:
        <div class="button" id="all" onclick="continue_proc(filterAll,'');">All</div>
        <div class="button" id="gpu1" onclick="continue_proc(filterByGPU,'1-2');">GPU 1-2</div>
        <div class="button" id="gpu2" onclick="continue_proc(filterByGPU,'3-4');">GPU 3-4</div>
        <div class="button" id="gpu3" onclick="continue_proc(filterByGPU,'5-8');">GPU 5-8</div>
        <div class="button" id="gpu4" onclick="continue_proc(filterByGPU,'9-16');">GPU 9-16</div>
    </div>
    <div class="buttons">
        Filter by provider:
        <div class="button" id="all" onclick="continue_proc(filterAll,'');">All</div>
        <div class="button" id="amazon" onclick="continue_proc(filterProvider,'amazon');">Amazon</div>
        <div class="button" id="gpu2" onclick="continue_proc(filterProvider,'softlayer');">Softlayer</div>
        <div class="button" id="gpu3" onclick="continue_proc(filterProvider,'cirrascale');">Cirrascale</div>
        <div class="button" id="gpu4" onclick="continue_proc(filterProvider,'sakura');">Sakura</div>
    </div>
    <div id="slice" style="width: 100%; height: 600px;"></div>

    <div class="buttons">
        Display for period:
        <div class="button" id="day" onclick="displaySlice(24 );">1 day</div>
        <div class="button" id="week" onclick="displaySlice(24 * 7);">1 week</div>
        <div class="button" id="month" onclick="displaySlice(24 * 30.5);">1 month</div>
        <div class="button" id="6months" onclick="displaySlice(24 * 30.5 * 6);">6 months</div>
        <div class="button" id="12months" onclick="displaySlice(24 * 365);">1 year</div>
    </div>

    <script>
    function loadData(filname) {
        Papa.parse(filname, {
            download: true,
            complete: processStaticData
        });
    }

    var offers_all=[];
    var offers=[];

    function processStaticData(results) {
        console.log("Rows: "+results.data.length);
        //console.log(results);
        //global offers;
        rows = results.data.length
        //rows = 7
        provider = ""
        for (var i=1; i<rows; i++) {
            row = results.data[i];
            //console.log(row);
            //console.log(i+" Provider:"+row[0]+" Offer:"+row[1]+" H.Price:"+row['2'])
            if (provider !=  row[0] && row[0] !="") {
                provider = row[0]
            }
            var offer = {
                provider: provider,
                name: row[1],
                shortname: row[2],
                hourly: row[3],
                weekly: row[4],
                monthly:row[5],
                yearly: row[6],
                cpu_p:  row[7],
                gpu_p:  row[8],
                gpus:   row[9]
            }
            offers_all.push(offer);
        }
        continue_proc(filterAll, "");
    }

    // "Filters" offers: save filtered list in "offers" global variable.
    function filterAll(arg) {
        offers = [];
        for (j=0; j < offers_all.length; j++) {
            offers.push(offers_all[j]);
        }
    }

    // Filters offers: save filtered list in "offers" global variable.
    // Filter out offers with GPUs in range given by group argument with format string "min-miax".
    function filterByGPU(group) {
        offers = [];
        min = 0;
        max = 0;
        splits = group.split("-");
        min = parseInt(splits[0]);
        max = parseInt(splits[1]);
        for (j=0; j < offers_all.length; j++) {
            if (offers_all[j].gpus >= min && offers_all[j].gpus <= max) {
                offers.push(offers_all[j]);
            }
        }
    }

    // Filter by provider
    function filterProvider(prov) {
        offers = [];
        //console.log("Filter " + prov.toLowerCase());
        for (j=0; j < offers_all.length; j++) {
            //console.log(offers_all[j].provider.toLowerCase());
            if (offers_all[j].provider.toLowerCase() == prov.toLowerCase()) {
                offers.push(offers_all[j]);
            }
        }
    }



    // Return array of Cost, Cost/CPU FLops, Cost/GPU FLops for given number of hours (period).
    // Period must be in hours.
    function getQuote(offer, step, period, dates) {
        var costs = [], costs_cpu=[], costs_gpu=[];
        if (offer.hourly != "" ) {
            for (var i=0; i <= period; i+=step) {
                cost = i * offer.hourly;
                costs.push(cost);
                costs_cpu.push(cost/offer.cpu_p);
                costs_gpu.push(cost/offer.gpu_p);
            }
        } else if (offer.weekly != "" ) {
            for (var i=0; i <= period; i+=step) {
                // Use i+1 because 7th day end should be the start of 2nd week
                period_w = Math.ceil((i + 1) / (24 * 7));
                cost = period_w * offer.weekly;
                costs.push(cost);
                costs_cpu.push(cost/offer.cpu_p);
                costs_gpu.push(cost/offer.gpu_p);
            }
        } else if (offer.monthly != "" ) {
            for (var h=0; h <= period; h+=step) {
                var i = Math.floor(h/step);
                console.log("M.Offer. h= "+h+" i="+i+" months="+dates[1][i].months + "years="+dates[1][i].years);
                var period_m = dates[1][i].years * 12 + dates[1][i].months+1;
                cost = period_m * offer.monthly;
                costs.push(cost);
                costs_cpu.push(cost/offer.cpu_p);
                costs_gpu.push(cost/offer.gpu_p);
            }
        } else if (offer.yearly != "" ) {
            for (var h=0; h <= period; h+=step) {
                var i = Math.floor(h/step);
                console.log("Y.Offer. h= "+h+" i="+i+" months="+dates[1][i].months + "years="+dates[1][i].years);
                period_y = dates[1][i].years+1;
                cost = period_y * offer.yearly;
                costs.push(cost);
                costs_cpu.push(cost/offer.cpu_p);
                costs_gpu.push(cost/offer.gpu_p);
            }
        }
        return [ costs, costs_cpu, costs_gpu];
    }

    var days_in_month = [31,28,31,30,31,30,31,31,30,31,30,31];
    var accumulated_months_days = [];

    // Convert time in hours to human readable format
    // Return object {years, months, days, text}
    function hoursToHuman(h) {
        var init_h = h;
        var hours_day   = 24;
        //var hours_month = 24 * 30.5;
        var hours_year  = 24 * accumulated_months_days[11];


        var years  = Math.floor(h / hours_year);
        h = h - (years * hours_year);

        // Months
        // Have numbers of days in months, so need to know how many full days we have.
        var days = Math.floor(h / hours_day);
        var m = 0;
        for (; m < 12; m++ ) {
            if (days < accumulated_months_days[m]) {
                break;
            }
        }
        var months = m;
        console.log("Calculating months. days="+days+" m="+m+ " months="+months+ " years="+years);

        if (months > 0) {
            h = h - accumulated_months_days[months-1] * hours_day;
        }

        // Days
        days   = Math.floor(h / hours_day);
        h = h - days * hours_day;

        // Hours
        var hours  = h;
        s = "";
        if ( years > 0) {
            s = s + years + " years ";
        }
        if ( months > 0) {
            s = s + months + " months ";
        }
        if ( days > 0) {
            s = s + days + " days ";
        }
        if ( hours > 0 || s.length < 2) {
            s = s + hours + " hours";
        }
        console.log("Count "+init_h+ " hours as "+ s );
        return [{
            years: years,
            months: months,
            days: days,
            hours: hours
            }, s ];
    }

    // Return array of dates from 0 to given period of hours
    // with 1 hour step. Second returned variable – array of years, months, days and hours and human readable labels.
    function prepDates(end, step) {
        var h_arr = [];
        var human =[];
        var text  =[];
        start_date = 0;
        for (h = 0; h <= end; h+=step) {
            h_arr.push(h);
            human_time = hoursToHuman(h)
            human.push(human_time[0]);
            text.push(human_time[1]);
        }
        return [h_arr, human, text];
    }

    var dates =[];
    var quotes=[];

    // Plot all offers costs for given period.
    function plotPeriod(period, step) {
        var tickvals = [];
        var ticktext = [];
        var traces = [];

        dates = prepDates(period, step);
        console.log(dates);
        // dates[0] - array of hours: 0,1,2,...,period
        // dates[1] - array of objects
        // dates[2] - array of human-readable text format dates
        console.log("Period is " + period+" (" + dates[0][dates[0].length-1] + ") hours");
        console.log("which is " + dates[2][dates[1].length-1]);

        var layout = {
            title: 'Cost per period (USD)',
            hovermode:'closest',
            showticklabels: false,
            xaxis: {
                tickvals: [0,   24*7,     24*30.5,   24*30.5*2,   24*30.5*3,  24*30.5*4,  24*30.5*5,  24*30.5*6,  24*30.5*7,  24*30.5*8,  24*30.5*9,  24*30.5*10,  24*30.5*11,  24*30.5*12 ],
                ticktext: ["0", "1 week", "1 month", "2 months", "3 months", "4 months", "5 months", "6 months", "7 months", "8 months", "9 months", "10 months", "11 months", "12 months"]
            },
            yaxis: {
                tickprefix: "$",
                hoverformat: '.2f',
                exponentformat: "none"
            }
        };

        for (j=0; j < offers.length; j++) {
            quote = getQuote(offers[j], step, period, dates);
            var trace = {
                mode: 'lines',
                line: {
                    width: 1
                },
                name: offers[j].shortname,
                hoverinfo:"y+name+text",
                x: dates[0],
                text: dates[2],
                y: quote[0] // 0 - Absolute cost
            };
            traces.push(trace);
            quotes.push(quote);
        }
        Plotly.newPlot("myDiv1", traces, layout);
    }

    loadData("cost-performance.csv");

    function continue_proc(filter, arg) {

        var step = 12; // 12-hour step

        if (accumulated_months_days.length < 1) {
            console.log("Calculate accumulated months days");
            accumulated_days = 0;
            for (var m = 0; m < 12; m++) {
                accumulated_days += days_in_month[m];
                accumulated_months_days.push(accumulated_days);
            }
            console.log(accumulated_months_days);
        }
        filter(arg);
        quotes=[];
        console.log("Have "+ offers.length+" offers.")
        //console.log("Have "+ quotes.length+" quotes.")
        plotPeriod(24*accumulated_months_days[11], step);  // Period for top plot
        console.log("Have "+ quotes.length+" quotes.")
        var myPlot = document.getElementById('myDiv1');

        myPlot.on('plotly_click', function(data) {
            //console.log(data);
            var pts = '';
            for(var i=0; i < data.points.length; i++) {
                displaySlice(data.points[i].pointNumber);
            }
        });

        // Display data for 1 month
        displaySlice(Math.floor(24 * accumulated_months_days[0] / step));
    }


    function displaySlice(n) {
        console.log("Clicked "+n+ " X: "+ dates[0][n] + " / " + dates[2][n]);
        var layout_bar = {
            title: "1 TFlops cost per " + dates[2][n],
            barmode: 'group',
            hovermode:'closest',
            xaxis: {
                fixedrange: true
            },
            yaxis: {
                title: 'Cost per CPU 1 TFlops (USD/TFlops)',
                tickprefix: "$",
                hoverformat: '.2f',
                exponentformat: "none",
                separatethousands: true,
                gridcolor: "#d9f0ff",
                linecolor: "#d9f0ff"
            },
            yaxis2: {
                title: 'Cost per GPU 1 TFlops (USD/TFlops)',
                overlaying: 'y',
                side: 'right',
                tickprefix: "$",
                hoverformat: '.2f',
                exponentformat: "none",
                separatethousands: true,
                gridcolor: "#ffe6d6",
                linecolor: "#ffe6d6"
            }
        };
        var y_cpu = [];
        var y_gpu = [];
        var x = [];
        console.log("displaySlice has " + offers.length+" offers.")
        for (j=0; j < offers.length; j++) {
            y_cpu.push(quotes[j][1][n]);
            y_gpu.push(quotes[j][2][n]);
            x.push(offers[j].shortname);
        }

        var trace_cpu = {
            x: x,
            y: y_cpu,
            name: "USD/CPU TFlops",
            offset: -0.4,
            width: 0.35,
            type: "bar"
        };

        var trace_gpu = {
            x: x,
            y: y_gpu,
            name: "USD/GPU TFlops",
            type: "bar",
            offset: 0,
            width: 0.35,
            yaxis: 'y2'
        };

        Plotly.newPlot('slice', [trace_cpu, trace_gpu], layout_bar);
    }

    </script>
</body>
</html>